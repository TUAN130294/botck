# -*- coding: utf-8 -*-
"""
config.py — cấu hình trung tâm (có hỗ trợ override bằng config_local.json)
"""

import os, json
from pathlib import Path
import pytz

# ========= TIMEZONE =========
TZ = pytz.timezone("Asia/Ho_Chi_Minh")

# ========= .env =========
from dotenv import load_dotenv, find_dotenv
_env_loaded = False
ENV_FILE = Path(__file__).resolve().with_name(".env")
if ENV_FILE.exists():
    _env_loaded = load_dotenv(dotenv_path=str(ENV_FILE))
else:
    alt = find_dotenv(filename=".env", usecwd=True)
    if alt:
        _env_loaded = load_dotenv(alt)

# ========= TOKEN & AI =========
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "").strip()
GEMINI_API_KEY     = os.getenv("GEMINI_API_KEY", "").strip()
FINNHUB_API_KEY    = os.getenv("FINNHUB_API_KEY", "").strip() # MỚI

# Có thể để rỗng, code sẽ dùng mặc định
_raw_urls = os.getenv("GEMINI_BASE_URLS", "").strip()
GEMINI_BASE_URLS = [u.strip().rstrip("/") for u in _raw_urls.split(",") if u.strip()] or [
    "https://api.key4u.shop",
    "https://api2.key4u.shop",
]
GEMINI_MODEL = os.getenv("GEMINI_MODEL", "gemini-2.5-flash")

# ========= BOT/ADMIN =========
ADMIN_IDS  = [int(x) for x in os.getenv("ADMIN_IDS", "").replace(";", ",").split(",") if x.strip().lstrip("-").isdigit()]
STATUS_PORT = int(os.getenv("STATUS_PORT", "8088"))
HEARTBEAT_CHAT_IDS = os.getenv("HEARTBEAT_CHAT_IDS", "").replace(";", ",")

TARGET_CHAT_IDS = []
for tok in [t.strip() for t in HEARTBEAT_CHAT_IDS.split(",") if t.strip()]:
    if tok.lstrip("-").isdigit():
        TARGET_CHAT_IDS.append(int(tok))

# ========= TA/DATA =========
# -*- coding: utf-8 -*-
"""
config.py — cấu hình trung tâm (có hỗ trợ override bằng config_local.json)
"""

import os, json
from pathlib import Path
import pytz

# ========= TIMEZONE =========
TZ = pytz.timezone("Asia/Ho_Chi_Minh")

# ========= .env =========
from dotenv import load_dotenv, find_dotenv
_env_loaded = False
ENV_FILE = Path(__file__).resolve().with_name(".env")
if ENV_FILE.exists():
    _env_loaded = load_dotenv(dotenv_path=str(ENV_FILE))
else:
    alt = find_dotenv(filename=".env", usecwd=True)
    if alt:
        _env_loaded = load_dotenv(alt)

# ========= TOKEN & AI =========
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "").strip()
GEMINI_API_KEY     = os.getenv("GEMINI_API_KEY", "").strip()
FINNHUB_API_KEY    = os.getenv("FINNHUB_API_KEY", "").strip() # MỚI

# Có thể để rỗng, code sẽ dùng mặc định
_raw_urls = os.getenv("GEMINI_BASE_URLS", "").strip()
GEMINI_BASE_URLS = [u.strip().rstrip("/") for u in _raw_urls.split(",") if u.strip()] or [
    "https://api.key4u.shop",
    "https://api2.key4u.shop",
]
GEMINI_MODEL = os.getenv("GEMINI_MODEL", "gemini-2.5-flash")

# ========= BOT/ADMIN =========
ADMIN_IDS  = [int(x) for x in os.getenv("ADMIN_IDS", "").replace(";", ",").split(",") if x.strip().lstrip("-").isdigit()]
STATUS_PORT = int(os.getenv("STATUS_PORT", "8088"))
HEARTBEAT_CHAT_IDS = os.getenv("HEARTBEAT_CHAT_IDS", "").replace(";", ",")
    except Exception:
        pass
NEAR_LEVEL_PERCENTAGE = 1.0
_apply_local_overrides()